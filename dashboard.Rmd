---
title: "IPCHEM Data Statistics"
output:
  flexdashboard::flex_dashboard:
    # logo: ./logo/eu.jpg
    vertical_layout: scroll
    orientation: rows
    css: custom.css
---

```{r setup, include=FALSE}
library(stringr)
library(tidyverse)
library(DT)
library(plotly)
library(flexdashboard)
library(leaflet)
library(maps)
library(lubridate)
source("fnutils.R")
```

Sidebar {.sidebar}
=======================================================================

<p style="font-size:13px">
IPCHEM allows the exploration of chemical occurrence data across different media (environment, human bio-monitoring, food and feed, products and indoor air)
</p>

<hr>

<!-- <style> -->
<!--         strong { -->
<!--             font-weight: bold; -->
<!--         } -->
<!--         navbar { -->
<!--             display: none; -->
<!--         } -->
<!-- </style> -->

<p style="font-size:13px">Report generated on: <b>`r Sys.Date()`</b></p>

<hr>

<h5>Data layers</h5>

<p style="font-size:13px">
<b>Record:</b> one measurement made at one point in time for a single place (1 measurement, 1 time, 1 location)
</p>

<p style="font-size:13px">
<b>Package:</b> a series of measurements for one chemical, at one point in time, for multiple locations (n measurements, 1 chemical, 1 time, n locations) 
</p>

<p style="font-size:13px">
<b>Dataset:</b> data provider dealing with chemical monitoring data
</p>

<p style="font-size:13px">
<b>Media:</b> environment where a measurement is made
</p>

<p style="font-size:13px">
<b>Module:</b> group of thematic areas where measurements are made
</p>

<hr>

<h5>Usage</h5>

<p style="font-size:13px"> 
<b>Plots:</b> fast double click on any item in legend to isolate it. Single click to remove it. Advanced features using top right tooltips.
</p>

<p style="font-size:13px">
<b>Tables:</b> default sorted in descending order by number of records
</p>

<p  style="font-size:13px">
<b>Map:</b> hover to show the number of records by country. 
</p>


```{r import_data, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

# load main data

url = "https://ipchem.jrc.ec.europa.eu/public/IPCHEM_public_dataset_packages.csv"

list_of_packages = get_csv_url(url)
list_of_packages = chg_col_names(list_of_packages)

world_cities <-
  read.table(
    "./data/worldcities.csv",
    header = TRUE,
    sep = ",",
    quote = "\"",
    dec = ".",
    encoding = "UTF-8"
  )

coordinates <- world_cities %>% 
  dplyr::filter(capital == 'primary')

wmap = maps::map("world", fill = TRUE, plot = FALSE)
```


```{r global, echo=FALSE, warning=FALSE}

list_of_packages = list_of_packages %>% 
  dplyr::filter(!is.na(chemical_name)) # %>% 
  # dplyr::filter(!is.na(period)) %>% 
  # dplyr::filter(!str_like(location, "%null%"))

# counts
n_datasets = length(unique(list_of_packages$dataset))
n_packages = length(unique(list_of_packages$package)) # NA is counted as 1. there are 2494 of them

# sums

sum_records = sum(list_of_packages$records)

# create pivot tables
pivot_media <- list_of_packages %>%
  group_by(media) %>%
  summarize(
    packages = n(),
    records = sum(records)
    ) %>% 
  ungroup() %>% 
  arrange(desc(records))

pivot_media_period <- list_of_packages %>%
  filter(!is.na(period)) %>% 
  group_by(media, period) %>%
  summarize(records = sum(records)) %>%
  mutate(records = cumsum(records))
  

# record and packages by dataset
pivot_dataset = list_of_packages %>% 
  group_by(dataset) %>% 
  summarize(
    packages = n(),
    records = sum(records)
    )%>% 
  ungroup() %>% 
  arrange(desc(records))

# pivot_dataset_period = list_of_packages %>%
#   filter(!is.na(period)) %>% 
#   group_by(dataset, period) %>%
#   summarize(records = sum(records))

pivot_dataset_period = list_of_packages %>%
  filter(!is.na(period)) %>% 
  select(dataset, period, records) %>% 
  left_join(pivot_dataset %>%
              top_n(10, records) %>% 
              select(-packages, -records) %>% 
              mutate(top_10 = 1),
            by = join_by(dataset == dataset)) %>% 
  mutate(dataset = ifelse(is.na(top_10), 'OTHER', dataset)) %>% 
  group_by(dataset, period) %>% 
  summarize(records = sum(records)) %>% 
  mutate(records = cumsum(records))

# record by module and period
pivot_module = list_of_packages %>% 
  select(dataset, records) %>% 
  left_join(env_modules, by = join_by(dataset == dataset)) %>% 
  group_by(module) %>% 
  summarize(packages = n(),
    records = sum(records))%>% 
  ungroup() %>% 
  arrange(desc(records))

# record by module and period
pivot_module_period = list_of_packages %>% 
  filter(!is.na(period)) %>%
  select(dataset, period, records) %>% 
  left_join(env_modules, by = join_by(dataset == dataset)) %>% 
  group_by(module, period) %>% 
  summarize(records = sum(records)) %>%
  mutate(records = cumsum(records))

# number of record by year
# pivot_period <- list_of_packages %>%
#   group_by(period) %>%
#   summarize(records = sum(records))

# split column location by each individual country and extract records
locations <- list_of_packages %>% 
  select(location, period, chemical_name) %>% 
  separate_rows(location, sep = ", ", convert = TRUE) %>% 
  mutate(country_code = str_split_fixed(location, ' \\[', 2)[, 1]) %>% 
  mutate(records = str_split_fixed(location, ' \\[', 2)[, 2]) %>%
  mutate(records = as.numeric(str_sub(records, 1, str_length(records) - 1))) %>% 
  select(-location)

# number or record by country
pivot_country = locations %>% 
  dplyr::filter(!is_null(country_code)) %>%
  dplyr::filter(country_code != "null") %>%
  group_by(country_code) %>% 
  summarize(records = sum(records))

pivot_region_period = locations %>% 
  inner_join(coordinates %>%
               select(country, iso3) %>% 
               distinct(), # some countries have more than 1 primary city
            by = join_by(country_code == iso3)) %>% 
  left_join(eu_27 %>% 
              mutate(region = 'eu_27'),
            by = join_by(country_code == code)) %>% 
  mutate(region = ifelse(is.na(region), 'other', region)) %>% 
  group_by(region, period) %>%
  summarize(records = sum(records)) %>% 
  mutate(records = cumsum(records))

# # number of records by country an period
# pivot_country_period = locations %>%
#   group_by(country_code, period) %>%
#   summarize(scores = sum(score)) %>% 
#   ungroup()
# 
# # bring the nice name of the country
# pivot_country_period = pivot_country_period %>% 
#   left_join(coordinates %>% 
#               select(country, iso3) %>% 
#               distinct(), # some countries have more than 1 primary city
#             by = join_by(country_code == iso3)) %>% 
#   filter(!is.na(country)) %>% # 1A0 country code does not exist in coordinates. what is it?
#   select(country, period, scores)

# which chemical has most of the records. top 10
chemical_pivot = list_of_packages %>% 
  filter(!is.na(chemical_name)) %>% 
  group_by(chemical_name) %>% 
  summarize(n = sum(records)) %>% 
  arrange(desc(n)) %>% 
  head(20)

# after split by country, sum the chemical records by country only for top chemicals
pivot_chemical_country = locations %>%
  inner_join(chemical_pivot %>% select(chemical_name),
             by = join_by(chemical_name == chemical_name)) %>%
  group_by(chemical_name, country_code) %>%
  summarize(records = sum(records))

# bring the nice name of the country
pivot_chemical_country = pivot_chemical_country %>% 
  left_join(coordinates %>% 
              select(country, iso3) %>% 
              distinct(), # some countries have more than 1 primary city
            by = join_by(country_code == iso3)) %>% 
  filter(!is.na(country)) %>% # 1A0 country code does not exist in coordinates. what is it?
  select(chemical_name, country, records)


# # create also the total for each country are record it as a country
# pivot_country_period = pivot_country_period %>% 
#   bind_rows(pivot_country_period %>% 
#               group_by(period) %>% 
#               summarize(scores = sum(scores)) %>% 
#               mutate(country = "TOTAL") %>% 
#               select(country, period, scores))

# create map
# extract coordinates for each country capital 
country_coordinates <- pivot_country %>%
  left_join(coordinates, by = join_by(country_code == iso3)) %>%
  filter(!is.na(city))

# remove duplicates
country_coordinates = country_coordinates %>% 
  group_by(country) %>% 
  mutate(rnk = row_number()) %>% 
  ungroup() %>% 
  filter(rnk == 1) %>% 
  select(-rnk)

# normalize some names
country_coordinates = country_coordinates %>%
  mutate(country = ifelse(country == "Czechia", "Czech Republic", country)) %>%
  mutate(country = ifelse(country == "Macedonia", "North Macedonia", country)) %>% 
  mutate(country = ifelse(country == "United States", "USA", country)) %>% 
  mutate(country = ifelse(country == "United Kingdom", "UK:Great Britain", country))

### the map
# color pallet based on records
pal = colorNumeric(palette = "YlGnBu", domain = country_coordinates$records, na.color = "#808080")
# pal = colorQuantile(palette = "YlGnBu", domain = country_coordinates$scores, n = 5, na.color = "#808080")

temp_df = data.frame(country = wmap$names)

temp_df = temp_df %>% 
  left_join(country_coordinates %>% 
              select(country, records),
            by = join_by(country == country)) %>% 
  mutate(color = pal(records))

wmap$color = temp_df$color
wmap$records = temp_df$records
wmap$labels = paste(wmap$names, paste(":", ifelse(
  is.na(wmap$records), "", formatC(wmap$records, big.mark = ",", format = "f", digits = 0)
)), sep = "\n")

# # label for pin on map
# content_popup <- paste(
#   sep = "<br/>",
#   paste("<b>", country_coordinates$country, "</b>"),
#   format(country_coordinates$scores, big.mark = ",")
# )
# 
# content_label <-
#   paste(
#     country_coordinates$country,
#     ": ",
#     format(country_coordinates$scores, big.mark = ",")
#   )


```

```{r}
# cleanup

rm(list_of_packages, locations, world_cities, temp_df)

```

Dashboard
=======================================================================

Row
-------------------------------------

### Number of Datasets

```{r}

valueBox(prettyNum(n_datasets, big.mark = ","), icon = "fa-database", color = "blue")

```

### Number of Packages

```{r}

valueBox(prettyNum(n_packages, big.mark = ","), icon = "fa-database", color = "orange")

```

### Number of Records

```{r}

valueBox(prettyNum(sum_records, big.mark = ","), icon = "fa-database", color = "green")

```


Row
-------------------------------------
### Top 20 chemicals records by country

```{r}

fig <- pivot_chemical_country %>% 
  mutate(country = str_sub(country, 1, 15)) %>% 
  plot_ly(
    x = ~ chemical_name,
    y = ~ records,
    type = 'bar',
    name = ~ country
  ) %>%
  layout(
    # title = 'Records per year',
    plot_bgcolor = '#e5ecf6',
    xaxis = list(
      title = 'Chemical',
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    ),
    yaxis = list(
      title = 'Number of Records',
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    )
  )

fig

```



Row
-------------------------------------

### Cummulative records by Module

```{r}

fig <-
  pivot_module_period %>%
  filter(period >= 1990) %>%
  # mutate(module = str_sub(module, 1, 10)) %>% # so the legend won't be pushed right
  plot_ly(
    x = ~ period,
    y = ~ records,
    # data = pivot_country_period,
    type = 'scatter',
    mode = "lines",
    name = ~ module,
    fill = 'tozeroy'
  ) %>%
  layout(
    # title = 'Records per year and country',
    plot_bgcolor = '#e5ecf6',
    xaxis = list(
      title = 'Year',
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    ),
    yaxis = list(
      title = 'Number of Records',
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    ),
    legend = list(x = 0.1, y = 0.9),
    showlegend = TRUE
  )

fig

```



### Cummulative records by Media
```{r}

fig <-
  pivot_media_period %>%
  filter(period >= 1990) %>%
  # mutate(media = str_sub(media, 1, 10)) %>% # so the legend won't be pushed right
  plot_ly(
    x = ~ period,
    y = ~ records,
    # data = pivot_country_period,
    type = 'scatter',
    mode = "lines",
    name = ~ media,
    fill = 'tozeroy'
  ) %>%
  layout(
    # title = 'Records per year and dataset',
    plot_bgcolor = '#e5ecf6',
    xaxis = list(
      title = 'Year',
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    ),
    yaxis = list(
      title = 'Number of Records',
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    ),
    legend = list(x = 0.1, y = 0.9),
    showlegend = TRUE
  )

fig

```

### Cummulative records by Dataset
```{r}

fig <-
  pivot_dataset_period %>%
  filter(period >= 1990) %>%
  # mutate(dataset = str_sub(dataset, 1, 10)) %>% # so the legend won't be pushed right
  plot_ly(
    x = ~ period,
    y = ~ records,
    # data = pivot_country_period,
    type = 'scatter',
    mode = "lines",
    name = ~ dataset,
    fill = 'tozeroy'
  ) %>%
  layout(
    # title = 'Records per year and dataset',
    plot_bgcolor = '#e5ecf6',
    xaxis = list(
      title = 'Year',
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    ),
    yaxis = list(
      title = 'Number of Records',
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    ),
    legend = list(x = 0.1, y = 0.9),
    showlegend = TRUE
  )

fig
```

Row
-------------------------------------

### Statistics by Module

```{r}

DT::datatable(pivot_module %>% 
                mutate(`%records` = 100 * records / sum(records)) %>%   
                mutate(packages = prettyNum(packages, big.mark = ",")) %>% 
                mutate(records = prettyNum(records, big.mark = ",")) %>% 
                mutate(`%records` =  formatC(`%records`, format = "f", digits = 2)),
              options = list(dom = 't',
                             bPaginate = FALSE,
                             columnDefs = list(list(className = 'dt-right', targets = 1:3))),
              rownames = FALSE)

```

### Statistics by Media

```{r}
DT::datatable(pivot_media %>% 
                mutate(`%records` = 100 * records / sum(records)) %>%   
                mutate(packages = prettyNum(packages, big.mark = ",")) %>% 
                mutate(records = prettyNum(records, big.mark = ",")) %>% 
                mutate(`%records` =  formatC(`%records`, format = "f", digits = 2)),
              options = list(dom = 't',
                             bPaginate = FALSE,
                             columnDefs = list(list(className = 'dt-right', targets = 1:3))),
              rownames = FALSE) 

```

### Statistics by Dataset

```{r}


DT::datatable(pivot_dataset %>% 
                mutate(`%records` = 100 * records / sum(records)) %>%   
                mutate(packages = prettyNum(packages, big.mark = ",")) %>% 
                mutate(records = prettyNum(records, big.mark = ",")) %>% 
                mutate(`%records` =  formatC(`%records`, format = "f", digits = 2)),
              options = list(dom = 't',
                             bPaginate = FALSE,
                             columnDefs = list(list(className = 'dt-right', targets = 1:3))),
              rownames = FALSE)

```




Row
-------------------------------------

### Map distribution of data records

```{r}


mp = leaflet(data = wmap,
             options = leafletOptions(
               minZoom = 2,
               maxZoom = 4,
               center = c(50.0875, 14.4214),
               zoom = 3
             )) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~ color,
    fillOpacity = 0.5,
    stroke = TRUE,
    color = "black",
    dashArray = "3",
    weight = 1,
    label = ~ labels,
    popup = ~ names
  ) %>%
  addLegend(
    "bottomright",
    pal = pal,
    values = ~ records,
    title = "Records",
    opacity = 1
  )

mp

```


### Cummulative country level records by year

```{r}

fig <-
  pivot_region_period %>%
  filter(period >= 1990) %>% 
  # mutate(country = str_sub(country, 1, 13)) %>% # so the legend won't be pushed right
  plot_ly(
    x = ~ period,
    y = ~ records,
    # data = pivot_country_period,
    type = 'scatter',
    mode = "lines",
    name = ~ region,
    fill = 'tozeroy'
  ) %>%
  layout(
    # title = 'Records per year and country',
    plot_bgcolor = '#e5ecf6',
    xaxis = list(
      title = 'Year',
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    ),
    yaxis = list(
      title = 'Number of Records',
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    ),
    legend = list(x = 0.1, y = 0.9),
    showlegend = TRUE
  )


fig

```

